name: PR Check

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

env:
  PACKAGES: 'SwarmTweaks SwarmAnimals SwarmEarplugs'

jobs:
  validate:
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for version consistency
        shell: pwsh
        run: |
          Write-Host "Checking version consistency across packages..."
          
          $packages = "${{ env.PACKAGES }}".Split(' ')
          $versions = @()
          
          foreach ($pkg in $packages) {
            $metaPath = "src/$pkg/meta.cpp"
            
            if (Test-Path $metaPath) {
              $content = Get-Content $metaPath -Raw
              if ($content -match 'version\s*=\s*"([^"]*)"') {
                $version = $matches[1]
                $versions += @{ Package = $pkg; Version = $version }
                Write-Host "$pkg : v$version"
              }
            }
          }
          
          $uniqueVersions = $versions.Version | Select-Object -Unique
          if ($uniqueVersions.Count -gt 1) {
            Write-Warning "Version mismatch detected across packages!"
            Write-Warning "Consider using build_all.bat --version X.X.X to sync versions"
          } else {
            Write-Host "✓ All packages have consistent version: $($uniqueVersions[0])"
          }

      - name: Validate file structure
        shell: pwsh
        run: |
          Write-Host "Validating mod structure..."
          
          # Check SwarmTweaks
          $tweaksFiles = @(
            "src/SwarmTweaks/config.cpp",
            "src/SwarmTweaks/meta.cpp",
            "src/SwarmTweaks/scripts/4_World/NoBuryItems.c"
          )
          
          # Check SwarmAnimals
          $animalsFiles = @(
            "src/SwarmAnimals/config.cpp",
            "src/SwarmAnimals/meta.cpp"
          )
          
          # Check SwarmEarplugs
          $earplugsFiles = @(
            "src/SwarmEarplugs/config.cpp",
            "src/SwarmEarplugs/meta.cpp",
            "src/SwarmEarplugs/scripts/5_Mission/MissionGameplay.c",
            "src/SwarmEarplugs/scripts/5_Mission/EarplugsWidget.c",
            "src/SwarmEarplugs/data/inputs.xml"
          )
          
          $allFiles = $tweaksFiles + $animalsFiles + $earplugsFiles
          $missing = @()
          
          foreach ($file in $allFiles) {
            if (-not (Test-Path $file)) {
              $missing += $file
              Write-Host "✗ Missing: $file"
            } else {
              Write-Host "✓ Found: $file"
            }
          }
          
          if ($missing.Count -gt 0) {
            Write-Error "$($missing.Count) required file(s) missing"
            exit 1
          }
          
          Write-Host "All required files present!"

      - name: Check for common issues
        shell: pwsh
        run: |
          Write-Host "Checking for common issues..."
          
          # Check for debug code patterns common in DayZ modding
          $debugPatterns = @(
            'Print\s*\(',           # Print() debug function
            'GetGame\(\)\.Chat\s*\(',  # Chat debug messages
            '//\s*DEBUG',           # DEBUG comments
            '#ifdef\s+DEBUG'        # Debug preprocessor
          )
          
          # Patterns that are warnings but not errors
          $warningPatterns = @(
            'TODO:',
            'FIXME:',
            'HACK:'
          )
          
          $scripts = Get-ChildItem -Path "src" -Filter "*.c" -Recurse
          $errors = @()
          $warnings = @()
          
          foreach ($script in $scripts) {
            $lineNum = 0
            
            foreach ($line in (Get-Content $script.FullName)) {
              $lineNum++
              
              # Check debug patterns (errors)
              foreach ($pattern in $debugPatterns) {
                if ($line -match $pattern -and $line -notmatch '^\s*//') {
                  $errors += "$($script.Name):$lineNum - Debug code: $($line.Trim().Substring(0, [Math]::Min(60, $line.Trim().Length)))"
                }
              }
              
              # Check warning patterns
              foreach ($pattern in $warningPatterns) {
                if ($line -match $pattern) {
                  $warnings += "$($script.Name):$lineNum - $pattern found"
                }
              }
            }
          }
          
          if ($warnings.Count -gt 0) {
            Write-Host ""
            Write-Host "Warnings ($($warnings.Count)):"
            foreach ($warning in $warnings) {
              Write-Warning $warning
            }
          }
          
          if ($errors.Count -gt 0) {
            Write-Host ""
            Write-Host "Debug code detected ($($errors.Count)):"
            foreach ($error in $errors) {
              Write-Error $error
            }
            Write-Host ""
            Write-Host "Please remove debug code before merging to main."
            exit 1
          }
          
          Write-Host "✓ No debug code detected"

      - name: Validate EnforceScript syntax
        shell: pwsh
        run: |
          Write-Host "Validating EnforceScript syntax..."
          
          $scripts = Get-ChildItem -Path "src" -Filter "*.c" -Recurse
          $errors = 0
          
          foreach ($script in $scripts) {
            $content = Get-Content $script.FullName -Raw
            $hasErrors = $false
            
            # Check brace matching
            $openBraces = ([regex]::Matches($content, '\{')).Count
            $closeBraces = ([regex]::Matches($content, '\}')).Count
            
            if ($openBraces -ne $closeBraces) {
              Write-Error "$($script.Name): Mismatched braces ({ = $openBraces, } = $closeBraces)"
              $hasErrors = $true
            }
            
            # Check parentheses matching
            $openParens = ([regex]::Matches($content, '\(')).Count
            $closeParens = ([regex]::Matches($content, '\)')).Count
            
            if ($openParens -ne $closeParens) {
              Write-Error "$($script.Name): Mismatched parentheses (( = $openParens, ) = $closeParens)"
              $hasErrors = $true
            }
            
            # Check for common EnforceScript class inheritance
            if ($content -match 'class\s+\w+\s*:\s*\w+' -or $content -match 'modded\s+class') {
              # Has class definitions - check for required methods
              if ($content -match 'override\s+' -and $content -notmatch 'super\.') {
                Write-Warning "$($script.Name): Override without super call detected (may be intentional)"
              }
            }
            
            if ($hasErrors) {
              $errors++
            } else {
              Write-Host "✓ $($script.Name)"
            }
          }
          
          if ($errors -gt 0) {
            Write-Error "$errors file(s) have syntax issues"
            exit 1
          }
          
          Write-Host "All scripts validated!"

  # Generate PR summary
  summary:
    needs: validate
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: PR Check Summary
        run: |
          echo "## PR Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.validate.result }}" == "success" ]; then
            echo "✅ All checks passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Some checks failed. Please review the errors above." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Checks Performed" >> $GITHUB_STEP_SUMMARY
          echo "- Version consistency across packages" >> $GITHUB_STEP_SUMMARY
          echo "- Required file structure" >> $GITHUB_STEP_SUMMARY
          echo "- Debug code detection" >> $GITHUB_STEP_SUMMARY
          echo "- EnforceScript syntax validation" >> $GITHUB_STEP_SUMMARY
