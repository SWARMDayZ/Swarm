name: Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      build_pbos:
        description: 'Build PBOs (requires self-hosted runner with DayZ Tools)'
        required: false
        type: boolean
        default: false

env:
  PACKAGES: 'SwarmTweaks SwarmAnimals SwarmEarplugs'
  MOD_NAME: '@Swarm'

jobs:
  validate:
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate config files
        shell: pwsh
        run: |
          Write-Host "Validating configuration files..."
          
          $packages = "${{ env.PACKAGES }}".Split(' ')
          
          foreach ($pkg in $packages) {
            $configPath = "src/$pkg/config.cpp"
            $metaPath = "src/$pkg/meta.cpp"
            
            if (-not (Test-Path $configPath)) {
              Write-Error "Missing config.cpp for $pkg"
              exit 1
            }
            
            if (-not (Test-Path $metaPath)) {
              Write-Error "Missing meta.cpp for $pkg"
              exit 1
            }
            
            Write-Host "✓ $pkg structure valid"
          }
          
          Write-Host "All packages validated successfully!"

      - name: Check script syntax
        shell: pwsh
        run: |
          Write-Host "Checking script files..."
          
          $scripts = Get-ChildItem -Path "src" -Filter "*.c" -Recurse
          $errors = 0
          
          foreach ($script in $scripts) {
            $content = Get-Content $script.FullName -Raw
            
            # Basic syntax checks for EnforceScript (.c files)
            $openBraces = ([regex]::Matches($content, '\{')).Count
            $closeBraces = ([regex]::Matches($content, '\}')).Count
            
            if ($openBraces -ne $closeBraces) {
              Write-Warning "Mismatched braces in $($script.FullName): { = $openBraces, } = $closeBraces"
              $errors++
            }
            
            # Check for common EnforceScript issues
            $lines = Get-Content $script.FullName
            $lineNum = 0
            foreach ($line in $lines) {
              $lineNum++
              
              # Check for missing semicolons (basic heuristic)
              if ($line -match '^\s*(return|int|float|string|bool|void|ref|auto)\s+\w+\s*$' -and $line -notmatch '[{;,]$') {
                Write-Warning "$($script.Name):$lineNum - Possible missing semicolon"
              }
            }
            
            if ($openBraces -eq $closeBraces) {
              Write-Host "✓ $($script.Name)"
            }
          }
          
          if ($errors -gt 0) {
            Write-Error "$errors file(s) have potential syntax issues"
            exit 1
          }
          
          Write-Host "All scripts passed basic syntax check!"

      - name: Validate CfgPatches references
        shell: pwsh
        run: |
          Write-Host "Validating CfgPatches in config.cpp files..."
          
          $packages = "${{ env.PACKAGES }}".Split(' ')
          
          foreach ($pkg in $packages) {
            $configPath = "src/$pkg/config.cpp"
            $content = Get-Content $configPath -Raw
            
            # Check for class CfgPatches
            if ($content -notmatch 'class\s+CfgPatches') {
              Write-Warning "$pkg config.cpp missing CfgPatches"
            }
            
            # Check for requiredAddons (should reference DayZ base)
            if ($content -notmatch 'requiredAddons\[\]') {
              Write-Warning "$pkg config.cpp missing requiredAddons"
            }
            
            Write-Host "✓ $pkg config.cpp validated"
          }

      - name: Upload source as artifact
        uses: actions/upload-artifact@v4
        with:
          name: swarm-source
          path: src/
          retention-days: 7

  # Optional PBO build job (requires self-hosted runner with DayZ Tools)
  build-pbos:
    needs: validate
    if: inputs.build_pbos == true || github.event_name == 'push'
    runs-on: [self-hosted, windows, dayz-tools]
    continue-on-error: true  # Don't fail the workflow if self-hosted runner unavailable
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check DayZ Tools availability
        id: check_tools
        shell: pwsh
        run: |
          if (-not $env:DAYZ_TOOLS) {
            Write-Warning "DAYZ_TOOLS environment variable not set"
            echo "AVAILABLE=false" >> $env:GITHUB_OUTPUT
            exit 0
          }
          
          $addonBuilder = "$env:DAYZ_TOOLS\Bin\AddonBuilder\AddonBuilder.exe"
          
          if (-not (Test-Path $addonBuilder)) {
            Write-Warning "AddonBuilder not found at: $addonBuilder"
            echo "AVAILABLE=false" >> $env:GITHUB_OUTPUT
            exit 0
          }
          
          Write-Host "DayZ Tools found!"
          echo "AVAILABLE=true" >> $env:GITHUB_OUTPUT
          echo "ADDON_BUILDER=$addonBuilder" >> $env:GITHUB_OUTPUT

      - name: Build PBOs
        if: steps.check_tools.outputs.AVAILABLE == 'true'
        shell: pwsh
        run: |
          $addonBuilder = "${{ steps.check_tools.outputs.ADDON_BUILDER }}"
          $outputDir = "dist/${{ env.MOD_NAME }}/Addons"
          
          Write-Host "Building PBOs..."
          New-Item -ItemType Directory -Force -Path $outputDir | Out-Null
          
          $packages = "${{ env.PACKAGES }}".Split(' ')
          $success = $true
          
          foreach ($pkg in $packages) {
            $srcPath = "src/$pkg"
            Write-Host ""
            Write-Host "Building $pkg..."
            
            $process = Start-Process -FilePath $addonBuilder `
              -ArgumentList "`"$srcPath`"", "`"$outputDir`"", "-clear", "-packonly" `
              -NoNewWindow -Wait -PassThru
            
            if ($process.ExitCode -ne 0) {
              Write-Warning "Failed to build $pkg (exit code: $($process.ExitCode))"
              $success = $false
            } else {
              Write-Host "✓ $pkg.pbo created"
            }
          }
          
          # Copy meta.cpp
          Copy-Item -Path "src/SwarmTweaks/meta.cpp" -Destination "dist/${{ env.MOD_NAME }}/meta.cpp"
          
          if (-not $success) {
            Write-Error "One or more packages failed to build"
            exit 1
          }
          
          Write-Host ""
          Write-Host "All PBOs built successfully!"

      - name: Upload PBO artifacts
        if: steps.check_tools.outputs.AVAILABLE == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: swarm-pbos
          path: dist/
          retention-days: 7

  # Summary job
  summary:
    needs: [validate, build-pbos]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Build Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | ${{ needs.validate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PBO Build | ${{ needs.build-pbos.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.build-pbos.result }}" == "skipped" ]; then
            echo "**Note:** PBO build was skipped (no self-hosted runner available or not requested)" >> $GITHUB_STEP_SUMMARY
          fi