name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string
      publish_workshop:
        description: 'Publish to Steam Workshop (requires self-hosted runner)'
        required: false
        type: boolean
        default: false

env:
  MOD_NAME: '@Swarm'
  PACKAGES: 'SwarmTweaks SwarmAnimals SwarmEarplugs'

jobs:
  build:
    runs-on: windows-latest
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        shell: pwsh
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $version = "${{ inputs.version }}"
          } else {
            $version = "${{ github.ref_name }}".TrimStart('v')
          }
          Write-Host "Version: $version"
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT

      - name: Update version in source files
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          Write-Host "Replacing %VERSION% placeholder with $version..."
          
          # Update .version file
          Set-Content -Path ".version" -Value $version -NoNewline
          Write-Host "Updated .version file"
          
          # Replace %VERSION% in all .cpp files under src/
          Get-ChildItem -Path "src" -Filter "*.cpp" -Recurse | ForEach-Object {
            $content = Get-Content $_.FullName -Raw
            if ($content -match '%VERSION%') {
              $newContent = $content -replace '%VERSION%', $version
              [System.IO.File]::WriteAllText($_.FullName, $newContent)
              Write-Host "Updated $($_.FullName)"
            }
          }

      - name: Check for DayZ Tools
        id: dayz_tools
        shell: pwsh
        run: |
          # Check common DayZ Tools installation paths
          $possiblePaths = @(
            "$env:DAYZ_TOOLS",
            "C:\Program Files (x86)\Steam\steamapps\common\DayZ Tools",
            "D:\Steam\steamapps\common\DayZ Tools",
            "E:\Steam\steamapps\common\DayZ Tools"
          )
          
          $addonBuilder = $null
          foreach ($path in $possiblePaths) {
            if ($path -and (Test-Path "$path\Bin\AddonBuilder\AddonBuilder.exe")) {
              $addonBuilder = "$path\Bin\AddonBuilder\AddonBuilder.exe"
              Write-Host "Found DayZ Tools at: $path"
              break
            }
          }
          
          if ($addonBuilder) {
            echo "HAS_DAYZ_TOOLS=true" >> $env:GITHUB_OUTPUT
            echo "ADDON_BUILDER=$addonBuilder" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "DayZ Tools not found - will create source package"
            echo "HAS_DAYZ_TOOLS=false" >> $env:GITHUB_OUTPUT
          }

      - name: Build PBOs with DayZ Tools
        if: steps.dayz_tools.outputs.HAS_DAYZ_TOOLS == 'true'
        shell: pwsh
        run: |
          $addonBuilder = "${{ steps.dayz_tools.outputs.ADDON_BUILDER }}"
          $outputDir = "dist/${{ env.MOD_NAME }}/Addons"
          
          Write-Host "Building PBOs with AddonBuilder..."
          New-Item -ItemType Directory -Force -Path $outputDir | Out-Null
          
          $packages = "${{ env.PACKAGES }}".Split(' ')
          
          foreach ($pkg in $packages) {
            $srcPath = "src/$pkg"
            Write-Host "Building $pkg..."
            
            & $addonBuilder $srcPath $outputDir -clear -packonly
            
            if ($LASTEXITCODE -ne 0) {
              Write-Error "Failed to build $pkg"
              exit 1
            }
            Write-Host "$pkg built successfully"
          }
          
          # Copy root meta.cpp to mod root (already has version replaced)
          Copy-Item -Path "src/meta.cpp" -Destination "dist/${{ env.MOD_NAME }}/meta.cpp"
          
          Write-Host "All PBOs built successfully!"

      - name: Create source package (fallback)
        if: steps.dayz_tools.outputs.HAS_DAYZ_TOOLS != 'true'
        shell: pwsh
        run: |
          Write-Host "Creating source package (DayZ Tools not available)..."
          
          $outputDir = "dist/${{ env.MOD_NAME }}/Addons"
          New-Item -ItemType Directory -Force -Path $outputDir | Out-Null
          
          $packages = "${{ env.PACKAGES }}".Split(' ')
          
          foreach ($pkg in $packages) {
            $srcPath = "src/$pkg"
            $destPath = "$outputDir/$pkg"
            
            if (Test-Path $srcPath) {
              Copy-Item -Path $srcPath -Destination $destPath -Recurse
              Write-Host "Copied $pkg"
            }
          }
          
          # Copy root meta.cpp to mod root (already has version replaced)
          Copy-Item -Path "src/meta.cpp" -Destination "dist/${{ env.MOD_NAME }}/meta.cpp"
          
          Write-Host "Source package created!"

      - name: Create release archive
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $hasPBOs = "${{ steps.dayz_tools.outputs.HAS_DAYZ_TOOLS }}" -eq "true"
          
          if ($hasPBOs) {
            $archiveName = "Swarm-v$version-PBO.zip"
          } else {
            $archiveName = "Swarm-v$version-Source.zip"
          }
          
          Write-Host "Creating release archive: $archiveName"
          
          Compress-Archive -Path "dist/${{ env.MOD_NAME }}" -DestinationPath $archiveName -Force
          
          # Also create individual package archives
          $packages = "${{ env.PACKAGES }}".Split(' ')
          foreach ($pkg in $packages) {
            $pkgPath = "dist/${{ env.MOD_NAME }}/Addons/$pkg*"
            if (Test-Path $pkgPath) {
              $pkgArchive = "$pkg-v$version.zip"
              Compress-Archive -Path $pkgPath -DestinationPath $pkgArchive -Force
              Write-Host "Created $pkgArchive"
            }
          }
          
          Write-Host "Archives created successfully!"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: swarm-build-v${{ steps.version.outputs.VERSION }}
          path: |
            dist/
            *.zip
          retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: swarm-build-v${{ needs.build.outputs.version }}

      - name: List artifacts
        run: ls -la

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Swarm v${{ needs.build.outputs.version }}
          tag_name: v${{ needs.build.outputs.version }}
          draft: false
          prerelease: false
          files: |
            *.zip
          body: |
            ## Swarm Mod v${{ needs.build.outputs.version }}
            
            ### Included Packages
            - **SwarmTweaks** - Gameplay tweaks (LessLaugh, CraftImprovisedSuppressor, NoBuryItems, ItemsInBack)
            - **SwarmAnimals** - Animal skinning configurations  
            - **SwarmEarplugs** - Volume control earplugs
            
            ### Installation (Server)
            1. Download `Swarm-v${{ needs.build.outputs.version }}-PBO.zip` (or Source if PBO not available)
            2. Extract to your DayZ server mods folder
            3. Add `@Swarm` to your server's `-mod=` parameter
            
            ### Installation (Steam Workshop)
            Subscribe to the mod on [Steam Workshop](https://steamcommunity.com/sharedfiles/filedetails/?id=${{ vars.WORKSHOP_ID }})
            
            ### Build Notes
            - **PBO builds**: Ready for production use
            - **Source builds**: Require PBO packing with DayZ Tools AddonBuilder before use
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Optional: Publish to Steam Workshop (requires self-hosted runner with DayZ Tools)
  publish-workshop:
    needs: [build, release]
    if: inputs.publish_workshop == true
    runs-on: [self-hosted, windows, dayz-tools]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: swarm-build-v${{ needs.build.outputs.version }}

      - name: Verify DayZ Tools
        id: verify_tools
        shell: pwsh
        run: |
          $publisherPath = "$env:DAYZ_TOOLS\Bin\Publisher\PublisherCmd.exe"
          
          if (-not (Test-Path $publisherPath)) {
            Write-Error "DayZ Tools Publisher not found at: $publisherPath"
            Write-Error "Please ensure DAYZ_TOOLS environment variable is set correctly"
            exit 1
          }
          
          Write-Host "DayZ Tools Publisher found: $publisherPath"
          echo "PUBLISHER=$publisherPath" >> $env:GITHUB_OUTPUT

      - name: Prepare Workshop content
        shell: pwsh
        run: |
          $modDir = "dist/${{ env.MOD_NAME }}"
          $version = "${{ needs.build.outputs.version }}"
          
          # Verify PBOs exist
          $pbos = Get-ChildItem -Path "$modDir/Addons" -Filter "*.pbo" -ErrorAction SilentlyContinue
          
          if ($pbos.Count -eq 0) {
            Write-Error "No PBO files found! Workshop publishing requires PBO builds."
            Write-Error "Please run this workflow on a self-hosted runner with DayZ Tools."
            exit 1
          }
          
          Write-Host "Found $($pbos.Count) PBO files:"
          $pbos | ForEach-Object { Write-Host "  - $($_.Name)" }
          
          # Create/update changelog
          $changelog = @"
          Version $version
          
          Changes in this version:
          - See GitHub release notes for details
          "@
          
          Set-Content -Path "$modDir/changelog.txt" -Value $changelog
          Write-Host "Workshop content prepared!"

      - name: Publish to Steam Workshop
        shell: pwsh
        env:
          STEAM_USERNAME: ${{ secrets.STEAM_USERNAME }}
          STEAM_PASSWORD: ${{ secrets.STEAM_PASSWORD }}
          WORKSHOP_ID: ${{ vars.WORKSHOP_ID }}
        run: |
          $publisher = "${{ steps.verify_tools.outputs.PUBLISHER }}"
          $modDir = "dist/${{ env.MOD_NAME }}"
          $version = "${{ needs.build.outputs.version }}"
          
          if (-not $env:WORKSHOP_ID) {
            Write-Error "WORKSHOP_ID variable not set. Please configure it in repository settings."
            exit 1
          }
          
          Write-Host "Publishing to Steam Workshop..."
          Write-Host "  Workshop ID: $env:WORKSHOP_ID"
          Write-Host "  Mod Directory: $modDir"
          Write-Host "  Version: $version"
          
          # Note: PublisherCmd syntax may vary - adjust based on actual DayZ Tools version
          # This assumes the mod is already registered in Workshop
          & $publisher update -modDir="$modDir" -changeNote="Version $version"
          
          if ($LASTEXITCODE -eq 0) {
            Write-Host "Successfully published to Steam Workshop!"
          } else {
            Write-Warning "Publisher returned exit code: $LASTEXITCODE"
            Write-Warning "Manual verification may be required"
          }

      - name: Post publish summary
        shell: pwsh
        run: |
          $workshopId = "${{ vars.WORKSHOP_ID }}"
          $version = "${{ needs.build.outputs.version }}"
          
          Write-Host ""
          Write-Host "=========================================="
          Write-Host "Steam Workshop Publish Summary"
          Write-Host "=========================================="
          Write-Host "Version: $version"
          Write-Host "Workshop URL: https://steamcommunity.com/sharedfiles/filedetails/?id=$workshopId"
          Write-Host "==========================================""