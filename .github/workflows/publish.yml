name: Publish to Steam Workshop

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.0.0)'
        required: true
        type: string
      change_note:
        description: 'Change note for Steam Workshop'
        required: false
        type: string
        default: ''
      key_name:
        description: 'Signing key name (must exist on runner)'
        required: false
        type: string
        default: 'Swarm'
      visibility:
        description: 'Workshop item visibility'
        required: false
        type: choice
        options:
          - public
          - friends_only
          - private
        default: public

env:
  MOD_NAME: '@Swarm'
  PACKAGES: 'SwarmTweaks SwarmAnimals SwarmEarplugs'
  KEY_NAME: ${{ inputs.key_name || 'Swarm' }}

jobs:
  # Build on self-hosted runner with DayZ Tools
  build-pbos:
    runs-on: [self-hosted, windows, dayz-tools]
    outputs:
      pbo_count: ${{ steps.build.outputs.PBO_COUNT }}
      sign_count: ${{ steps.sign.outputs.SIGN_COUNT }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate DayZ Tools installation
        id: validate
        shell: pwsh
        run: |
          Write-Host "Validating DayZ Tools installation..."
          
          if (-not $env:DAYZ_TOOLS) {
            Write-Error "DAYZ_TOOLS environment variable not set!"
            Write-Host "Please set DAYZ_TOOLS to your DayZ Tools installation path"
            Write-Host "Example: C:\Program Files (x86)\Steam\steamapps\common\DayZ Tools"
            exit 1
          }
          
          $addonBuilder = "$env:DAYZ_TOOLS\Bin\AddonBuilder\AddonBuilder.exe"
          $publisher = "$env:DAYZ_TOOLS\Bin\Publisher\PublisherCmd.exe"
          $dsSignFile = "$env:DAYZ_TOOLS\Bin\DsUtils\DSSignFile.exe"
          
          if (-not (Test-Path $addonBuilder)) {
            Write-Error "AddonBuilder not found at: $addonBuilder"
            exit 1
          }
          
          if (-not (Test-Path $publisher)) {
            Write-Error "PublisherCmd not found at: $publisher"
            exit 1
          }
          
          if (-not (Test-Path $dsSignFile)) {
            Write-Error "DSSignFile not found at: $dsSignFile"
            exit 1
          }
          
          Write-Host "DayZ Tools validated successfully!"
          Write-Host "  AddonBuilder: $addonBuilder"
          Write-Host "  Publisher: $publisher"
          Write-Host "  DSSignFile: $dsSignFile"
          
          echo "ADDON_BUILDER=$addonBuilder" >> $env:GITHUB_OUTPUT
          echo "PUBLISHER=$publisher" >> $env:GITHUB_OUTPUT
          echo "DS_SIGN_FILE=$dsSignFile" >> $env:GITHUB_OUTPUT

      - name: Update version in source files
        shell: pwsh
        run: |
          $version = "${{ inputs.version }}"
          Write-Host "Updating all packages to version $version..."
          
          $packages = "${{ env.PACKAGES }}".Split(' ')
          
          foreach ($pkg in $packages) {
            $metaPath = "src/$pkg/meta.cpp"
            if (Test-Path $metaPath) {
              $content = Get-Content $metaPath -Raw
              $content = $content -replace 'version\s*=\s*"[^"]*"', "version = `"$version`""
              Set-Content -Path $metaPath -Value $content -NoNewline
              Write-Host "Updated $metaPath"
            }
            
            $configPath = "src/$pkg/config.cpp"
            if (Test-Path $configPath) {
              $content = Get-Content $configPath -Raw
              $content = $content -replace 'version\s*=\s*"[^"]*"', "version = `"$version`""
              Set-Content -Path $configPath -Value $content -NoNewline
              Write-Host "Updated $configPath"
            }
          }

      - name: Build PBOs
        id: build
        shell: pwsh
        run: |
          $addonBuilder = "${{ steps.validate.outputs.ADDON_BUILDER }}"
          $outputDir = "dist/${{ env.MOD_NAME }}/Addons"
          $version = "${{ inputs.version }}"
          
          Write-Host "Building PBOs with AddonBuilder..."
          Write-Host "Output directory: $outputDir"
          
          # Clean and create output directory
          if (Test-Path "dist") {
            Remove-Item -Path "dist" -Recurse -Force
          }
          New-Item -ItemType Directory -Force -Path $outputDir | Out-Null
          
          $packages = "${{ env.PACKAGES }}".Split(' ')
          $builtCount = 0
          
          foreach ($pkg in $packages) {
            $srcPath = "src/$pkg"
            Write-Host ""
            Write-Host "Building $pkg..."
            Write-Host "  Source: $srcPath"
            
            $process = Start-Process -FilePath $addonBuilder `
              -ArgumentList "`"$srcPath`"", "`"$outputDir`"", "-clear", "-packonly" `
              -NoNewWindow -Wait -PassThru
            
            if ($process.ExitCode -ne 0) {
              Write-Error "Failed to build $pkg (exit code: $($process.ExitCode))"
              exit 1
            }
            
            $pboFile = "$outputDir/$pkg.pbo"
            if (Test-Path $pboFile) {
              $size = (Get-Item $pboFile).Length / 1KB
              Write-Host "  Created: $pkg.pbo ($([math]::Round($size, 2)) KB)"
              $builtCount++
            } else {
              Write-Warning "  PBO file not found at expected location: $pboFile"
            }
          }
          
          # Copy meta.cpp to mod root
          Copy-Item -Path "src/SwarmTweaks/meta.cpp" -Destination "dist/${{ env.MOD_NAME }}/meta.cpp"
          
          Write-Host ""
          Write-Host "Build complete! $builtCount PBOs created."
          echo "PBO_COUNT=$builtCount" >> $env:GITHUB_OUTPUT

      - name: Sign PBO files
        id: sign
        shell: pwsh
        run: |
          $dsSignFile = "${{ steps.validate.outputs.DS_SIGN_FILE }}"
          $modDir = "dist/${{ env.MOD_NAME }}"
          $keyName = "${{ env.KEY_NAME }}"
          
          Write-Host "Signing PBO files with key: $keyName"
          Write-Host ""
          
          # Look for private key in common locations
          $keyLocations = @(
            "$env:USERPROFILE\DayZKeys\$keyName.biprivatekey",
            "$env:DAYZ_TOOLS\Keys\$keyName.biprivatekey",
            "keys\$keyName.biprivatekey",
            "$keyName.biprivatekey"
          )
          
          $privateKey = $null
          foreach ($loc in $keyLocations) {
            if (Test-Path $loc) {
              $privateKey = $loc
              Write-Host "Found private key at: $loc"
              break
            }
          }
          
          if (-not $privateKey) {
            Write-Error "Private key not found: $keyName.biprivatekey"
            Write-Host ""
            Write-Host "Expected locations:"
            $keyLocations | ForEach-Object { Write-Host "  - $_" }
            Write-Host ""
            Write-Host "Please ensure the private key is available on the self-hosted runner."
            exit 1
          }
          
          # Get public key path (same folder as private key)
          $keyDir = Split-Path $privateKey -Parent
          $publicKey = Join-Path $keyDir "$keyName.bikey"
          
          if (-not (Test-Path $publicKey)) {
            Write-Error "Public key not found: $publicKey"
            exit 1
          }
          
          # Create Keys folder in mod directory
          $modKeysDir = "$modDir\Keys"
          if (-not (Test-Path $modKeysDir)) {
            New-Item -ItemType Directory -Force -Path $modKeysDir | Out-Null
          }
          
          # Copy public key to mod
          Copy-Item -Path $publicKey -Destination $modKeysDir -Force
          Write-Host "Copied public key to: $modKeysDir\$keyName.bikey"
          Write-Host ""
          
          # Sign all PBO files
          $signCount = 0
          $signErrors = 0
          
          Get-ChildItem -Path "$modDir\Addons" -Filter "*.pbo" | ForEach-Object {
            Write-Host "Signing: $($_.Name)"
            
            # Remove existing signatures
            Remove-Item -Path "$modDir\Addons\$($_.BaseName).*.bisign" -Force -ErrorAction SilentlyContinue
            
            # Sign the PBO
            $process = Start-Process -FilePath $dsSignFile `
              -ArgumentList "`"$privateKey`"", "`"$($_.FullName)`"" `
              -NoNewWindow -Wait -PassThru
            
            if ($process.ExitCode -eq 0) {
              $signCount++
              Write-Host "  Signed successfully"
            } else {
              $signErrors++
              Write-Warning "  Failed to sign (exit code: $($process.ExitCode))"
            }
          }
          
          Write-Host ""
          Write-Host "Signed $signCount PBO file(s)"
          
          if ($signErrors -gt 0) {
            Write-Warning "$signErrors file(s) failed to sign"
          }
          
          # List signatures
          Write-Host ""
          Write-Host "Signatures created:"
          Get-ChildItem -Path "$modDir\Addons" -Filter "*.bisign" | ForEach-Object {
            Write-Host "  $($_.Name)"
          }
          
          echo "SIGN_COUNT=$signCount" >> $env:GITHUB_OUTPUT

      - name: Prepare Workshop content
        shell: pwsh
        run: |
          $modDir = "dist/${{ env.MOD_NAME }}"
          $version = "${{ inputs.version }}"
          
          Write-Host "Preparing Workshop content..."
          
          # Create mod.cpp if it doesn't exist (Workshop requirement)
          $modCpp = @"
          name = "Swarm";
          picture = "";
          actionName = "";
          action = "";
          logo = "";
          logoSmall = "";
          logoOver = "";
          tooltip = "Swarm - DayZ Mod Collection";
          overview = "A collection of DayZ mods including SwarmTweaks, SwarmAnimals, and SwarmEarplugs.";
          author = "Swarm Team";
          version = "$version";
          "@
          
          # Only create if doesn't exist
          if (-not (Test-Path "$modDir/mod.cpp")) {
            Set-Content -Path "$modDir/mod.cpp" -Value $modCpp
            Write-Host "Created mod.cpp"
          }
          
          # List final content
          Write-Host ""
          Write-Host "Workshop content:"
          Get-ChildItem -Path $modDir -Recurse | ForEach-Object {
            $relativePath = $_.FullName.Replace((Get-Location).Path + "\", "")
            if ($_.PSIsContainer) {
              Write-Host "  [DIR]  $relativePath"
            } else {
              $size = $_.Length / 1KB
              Write-Host "  [FILE] $relativePath ($([math]::Round($size, 2)) KB)"
            }
          }

      - name: Upload PBO artifacts
        uses: actions/upload-artifact@v4
        with:
          name: swarm-pbos-v${{ inputs.version }}
          path: dist/
          retention-days: 30

  # Publish to Steam Workshop
  publish:
    needs: build-pbos
    runs-on: [self-hosted, windows, dayz-tools]
    if: needs.build-pbos.outputs.pbo_count > 0
    
    steps:
      - name: Download PBO artifacts
        uses: actions/download-artifact@v4
        with:
          name: swarm-pbos-v${{ inputs.version }}
          path: dist/

      - name: Verify Workshop configuration
        shell: pwsh
        run: |
          Write-Host "Verifying Workshop configuration..."
          
          if (-not "${{ vars.WORKSHOP_ID }}") {
            Write-Error "WORKSHOP_ID repository variable not set!"
            Write-Host ""
            Write-Host "To configure Workshop publishing:"
            Write-Host "1. Create your mod on Steam Workshop manually first"
            Write-Host "2. Get the Workshop ID from the URL (steamcommunity.com/sharedfiles/filedetails/?id=XXXXXXXX)"
            Write-Host "3. Add WORKSHOP_ID as a repository variable in GitHub Settings > Secrets and Variables > Actions > Variables"
            exit 1
          }
          
          if (-not "${{ secrets.STEAM_USERNAME }}") {
            Write-Error "STEAM_USERNAME secret not set!"
            exit 1
          }
          
          Write-Host "Workshop ID: ${{ vars.WORKSHOP_ID }}"
          Write-Host "Steam Username: [configured]"
          Write-Host "Configuration verified!"

      - name: Publish to Steam Workshop
        shell: pwsh
        env:
          STEAM_USERNAME: ${{ secrets.STEAM_USERNAME }}
          STEAM_PASSWORD: ${{ secrets.STEAM_PASSWORD }}
          STEAM_GUARD_CODE: ${{ secrets.STEAM_GUARD_CODE }}
        run: |
          $publisher = "$env:DAYZ_TOOLS\Bin\Publisher\PublisherCmd.exe"
          $modDir = "dist/${{ env.MOD_NAME }}"
          $version = "${{ inputs.version }}"
          $workshopId = "${{ vars.WORKSHOP_ID }}"
          
          # Prepare change note
          $changeNote = "${{ inputs.change_note }}"
          if (-not $changeNote) {
            $changeNote = "Version $version"
          }
          
          Write-Host "=========================================="
          Write-Host "Publishing to Steam Workshop"
          Write-Host "=========================================="
          Write-Host "Workshop ID: $workshopId"
          Write-Host "Mod Directory: $modDir"
          Write-Host "Version: $version"
          Write-Host "Change Note: $changeNote"
          Write-Host ""
          
          # Verify mod directory
          if (-not (Test-Path $modDir)) {
            Write-Error "Mod directory not found: $modDir"
            exit 1
          }
          
          # Count PBOs
          $pbos = Get-ChildItem -Path "$modDir/Addons" -Filter "*.pbo"
          Write-Host "PBOs to publish: $($pbos.Count)"
          $pbos | ForEach-Object { Write-Host "  - $($_.Name)" }
          Write-Host ""
          
          # Execute Publisher
          # Note: The exact command syntax depends on DayZ Tools version
          # Common options: update, -modDir, -changeNote
          Write-Host "Executing Publisher..."
          
          $args = @(
            "update"
            "-modDir=`"$modDir`""
            "-changeNote=`"$changeNote`""
          )
          
          # Add Steam Guard code if provided (for 2FA)
          if ($env:STEAM_GUARD_CODE) {
            Write-Host "Steam Guard code provided"
          }
          
          & $publisher $args
          $exitCode = $LASTEXITCODE
          
          Write-Host ""
          if ($exitCode -eq 0) {
            Write-Host "=========================================="
            Write-Host "SUCCESS: Published to Steam Workshop!"
            Write-Host "=========================================="
            Write-Host "View your mod: https://steamcommunity.com/sharedfiles/filedetails/?id=$workshopId"
          } else {
            Write-Warning "Publisher exited with code: $exitCode"
            Write-Warning ""
            Write-Warning "Common issues:"
            Write-Warning "  - Steam Guard: Update STEAM_GUARD_CODE secret with current code"
            Write-Warning "  - First publish: Create mod manually via DayZ Tools Publisher GUI first"
            Write-Warning "  - Auth expired: Re-authenticate via Steam client on runner machine"
            exit $exitCode
          }

      - name: Update Workshop visibility
        if: inputs.visibility != 'public'
        shell: pwsh
        run: |
          Write-Host "Note: Visibility change to '${{ inputs.visibility }}' may require manual action"
          Write-Host "Steam Workshop visibility can be changed at:"
          Write-Host "https://steamcommunity.com/sharedfiles/filedetails/?id=${{ vars.WORKSHOP_ID }}"

  # Summary job
  summary:
    needs: [build-pbos, publish]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Publish Summary
        run: |
          echo "## Steam Workshop Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ inputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PBOs Built | ${{ needs.build-pbos.outputs.pbo_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PBOs Signed | ${{ needs.build-pbos.outputs.sign_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Signing Key | ${{ env.KEY_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Workshop ID | ${{ vars.WORKSHOP_ID }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Status | ${{ needs.build-pbos.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Publish Status | ${{ needs.publish.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.publish.result }}" == "success" ]; then
            echo "### Workshop URL" >> $GITHUB_STEP_SUMMARY
            echo "https://steamcommunity.com/sharedfiles/filedetails/?id=${{ vars.WORKSHOP_ID }}" >> $GITHUB_STEP_SUMMARY
          fi
